---
import { existsSync, readdirSync, readFileSync } from "node:fs";
import path from "node:path";

const galleryDir = path.resolve("public/gallery");
const imageExtensions = new Set([
  ".jpg",
  ".jpeg",
  ".png",
  ".webp",
  ".avif",
  ".gif",
  ".svg"
]);

let items = [];

if (existsSync(galleryDir)) {
  const files = readdirSync(galleryDir).sort();
  const imageFiles = files.filter((file) => {
    const ext = path.extname(file).toLowerCase();
    return imageExtensions.has(ext);
  });

  items = imageFiles.map((file, index) => {
    const base = file.slice(0, -path.extname(file).length);
    const descriptionPath = path.join(galleryDir, `${base}.txt`);
    const fallback = `Description ${String(index + 1).padStart(2, "0")}: Add your photo details here.`;

    const description = existsSync(descriptionPath)
      ? readFileSync(descriptionPath, "utf8").trim() || fallback
      : fallback;

    return {
      title: `Photo ${String(index + 1).padStart(2, "0")}`,
      src: `/gallery/${file}`,
      description
    };
  });
}

const initialItem = items[0] ?? null;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Photo Gallery Exhibition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Work+Sans:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #000;
        --text: #f8f8f8;
        --text-muted: rgba(248, 248, 248, 0.72);
        --header-height: 84px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        background: var(--bg);
      }

      body {
        color: var(--text);
        font-family: "Work Sans", "Segoe UI", sans-serif;
      }

      .gallery {
        position: relative;
        min-height: 100vh;
        padding: 10px 16px 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .header-bar,
      .frame,
      .controls {
        opacity: 0;
        transition: opacity 0.8s ease;
      }

      .gallery.started .header-bar,
      .gallery.started .frame,
      .gallery.started .controls {
        opacity: 1;
      }

      .header-bar {
        position: relative;
        z-index: 4;
        width: 100%;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        align-items: center;
        gap: 8px;
        height: var(--header-height);
        padding: 4px 8px 12px;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.94),
          rgba(0, 0, 0, 0.72)
        );
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .top-description {
        min-width: 0;
        width: min(98vw, 1700px);
        margin: 0 auto;
        text-align: center;
        opacity: 0;
        transform: translateY(-6px);
        transition: opacity 2.5s ease, transform 2.5s ease;
      }

      .gallery.desc-on-top .top-description {
        opacity: 0.96;
        transform: translateY(0);
      }

      .top-main {
        margin: 0;
        font-family: "Cormorant Garamond", Georgia, serif;
        font-size: clamp(1rem, 1.8vw, 1.35rem);
        font-weight: 700;
        letter-spacing: 0.04em;
        color: rgba(248, 248, 248, 0.92);
        line-height: 1.22;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .top-meta {
        margin: 4px 0 0;
        font-size: clamp(0.7rem, 1.05vw, 0.9rem);
        letter-spacing: 0.03em;
        line-height: 1.45;
        color: var(--text-muted);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .frame {
        margin: 0;
        flex: 1;
        width: 100%;
        display: grid;
        place-items: center;
      }

      .photo {
        max-width: min(95vw, 1400px);
        max-height: calc(100vh - var(--header-height) - 44px);
        width: auto;
        height: auto;
        object-fit: contain;
        filter: drop-shadow(0 0 24px rgba(255, 255, 255, 0.08));
        opacity: 1;
        transition: opacity 2.5s ease;
      }

      .gallery.auto-description .photo {
        opacity: 0;
      }

      .gallery.instant-hide .photo {
        transition-duration: 0s;
      }

      .stage-description {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: min(90vw, 900px);
        text-align: center;
        opacity: 0;
        transition: opacity 2.5s ease, transform 2.5s ease;
        z-index: 5;
        pointer-events: none;
      }

      .gallery.auto-description .stage-description {
        opacity: 1;
        transform: translate(-50%, -50%);
      }

      .stage-title {
        margin: 0 0 12px;
        font-family: "Cormorant Garamond", Georgia, serif;
        font-size: clamp(1.2rem, 2.6vw, 2rem);
        letter-spacing: 0.06em;
      }

      .stage-text {
        margin: 0;
        font-size: clamp(0.85rem, 1.8vw, 1.05rem);
        line-height: 1.65;
        color: var(--text-muted);
        white-space: pre-line;
      }

      .controls {
        position: fixed;
        right: 20px;
        bottom: 20px;
        z-index: 4;
        display: flex;
        gap: 8px;
        pointer-events: none;
        opacity: 0.04;
        transform: scale(0.6);
        transform-origin: bottom right;
        transition: opacity 0.35s ease, transform 0.35s ease;
      }

      .gallery.started .controls {
        pointer-events: auto;
      }

      .gallery.started .controls:hover,
      .gallery.started .controls:focus-within {
        opacity: 0.96;
      }

      .btn {
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.015);
        color: rgba(248, 248, 248, 0.18);
        padding: 10px 14px;
        cursor: pointer;
        font-size: 0.82rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        transition: color 0.25s ease, border-color 0.25s ease, background-color 0.25s ease;
      }

      .gallery.started .controls:hover .btn,
      .gallery.started .controls:focus-within .btn {
        border-color: rgba(255, 255, 255, 0.62);
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.96);
      }

      .mini-btn {
        padding: 8px 10px;
        font-size: 0.7rem;
        letter-spacing: 0.06em;
      }

      .auto-mode {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-left: 2px;
        padding: 0 2px;
        color: rgba(248, 248, 248, 0.2);
        font-size: 0.72rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        transition: color 0.25s ease;
      }

      .gallery.started .controls:hover .auto-mode,
      .gallery.started .controls:focus-within .auto-mode {
        color: rgba(255, 255, 255, 0.96);
      }

      .auto-switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 22px;
      }

      .auto-switch input {
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute;
      }

      .auto-slider {
        position: absolute;
        inset: 0;
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.03);
        transition: background-color 0.25s ease, border-color 0.25s ease;
        cursor: pointer;
      }

      .auto-slider::before {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        left: 2px;
        top: 2px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.42);
        transition: transform 0.25s ease;
      }

      .gallery.started .controls:hover .auto-slider,
      .gallery.started .controls:focus-within .auto-slider {
        border-color: rgba(255, 255, 255, 0.62);
        background: rgba(255, 255, 255, 0.08);
      }

      .gallery.started .controls:hover .auto-slider::before,
      .gallery.started .controls:focus-within .auto-slider::before {
        background: rgba(255, 255, 255, 0.96);
      }

      .auto-switch input:checked + .auto-slider {
        background: rgba(60, 214, 103, 0.62);
        border-color: rgba(60, 214, 103, 0.95);
      }

      .auto-switch input:checked + .auto-slider::before {
        transform: translateX(18px);
      }

      .intro {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 8;
        display: grid;
        place-items: center;
        overflow: hidden;
      }

      .intro.hidden {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.55s ease, visibility 0.55s linear;
      }

      .curtain-panel {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 50%;
        background: linear-gradient(90deg, #0c0c0c, #000);
        transition: transform 1.15s cubic-bezier(0.15, 0.9, 0.2, 1);
      }

      .curtain-left {
        left: 0;
      }

      .curtain-right {
        right: 0;
        background: linear-gradient(270deg, #0c0c0c, #000);
      }

      .intro.opening .curtain-left {
        transform: translateX(-100%);
      }

      .intro.opening .curtain-right {
        transform: translateX(100%);
      }

      .intro-content {
        position: relative;
        z-index: 2;
        text-align: center;
        padding: 24px;
        transition: opacity 0.35s ease;
      }

      .intro.opening .intro-content {
        opacity: 0;
      }

      .intro-kicker {
        margin: 0 0 10px;
        color: var(--text-muted);
        letter-spacing: 0.2em;
        text-transform: uppercase;
        font-size: 0.78rem;
      }

      .intro-title {
        margin: 0 0 24px;
        font-family: "Cormorant Garamond", Georgia, serif;
        font-size: clamp(2rem, 5vw, 4.2rem);
        font-weight: 500;
        letter-spacing: 0.06em;
      }

      .start-btn {
        font-size: 0.85rem;
        padding: 12px 22px;
      }

      .intro-note {
        position: absolute;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        margin: 0;
        width: min(92vw, 760px);
        text-align: center;
        font-size: 0.6rem;
        color: var(--text-muted);
        letter-spacing: 0.05em;
        line-height: 1.7;
      }

      .empty {
        text-align: center;
        color: var(--text-muted);
        font-size: 1rem;
        line-height: 1.7;
      }

      @media (max-width: 700px) {
        :root {
          --header-height: 104px;
        }

        .header-bar {
          gap: 8px;
          grid-template-columns: 1fr;
          align-items: center;
          padding: 4px 4px 10px;
        }

        .controls {
          right: 14px;
          bottom: 14px;
        }

        .photo {
          max-height: calc(100vh - var(--header-height) - 52px);
        }
      }

      @media (hover: none) {
        .gallery.started .controls {
          opacity: 0.18;
        }
      }
    </style>
  </head>
  <body>
    <main
      class="gallery"
      data-items={JSON.stringify(items)}
      data-count={items.length}
    >
      <header class="header-bar">
        <div id="top-description" class="top-description">
          <p id="top-main" class="top-main"></p>
          <p id="top-meta" class="top-meta"></p>
        </div>
      </header>

      {
        initialItem ? (
          <>
            <section id="intro" class="intro">
              <div class="curtain-panel curtain-left"></div>
              <div class="curtain-panel curtain-right"></div>
              <div class="intro-content">
                <p class="intro-kicker">Photo Exhibition</p>
                <h2 class="intro-title">Gallery</h2>
                <button id="start-btn" class="btn start-btn" type="button">
                  Start Exhibition
                </button>
              </div>
              <p class="intro-note">
                Launches in fullscreen if available.
                <br />
                Use Space/Backspace for next.
              </p>
            </section>
            <figure class="frame">
              <img
                id="photo"
                class="photo"
                src={initialItem.src}
                alt={initialItem.title}
              />
            </figure>
            <section id="stage-description" class="stage-description">
              <h2 id="stage-title" class="stage-title">{initialItem.title}</h2>
              <p id="stage-text" class="stage-text">{initialItem.description}</p>
            </section>
            <div class="controls">
              <button id="fs-btn" class="btn mini-btn" type="button">Full</button>
              <button id="prev-btn" class="btn" type="button">Prev</button>
              <button id="next-btn" class="btn" type="button">Next</button>
              <div class="auto-mode">
                <span>Auto</span>
                <label class="auto-switch" for="auto-toggle">
                  <input
                    id="auto-toggle"
                    type="checkbox"
                    aria-label="Toggle automatic slideshow"
                  />
                  <span class="auto-slider"></span>
                </label>
                <span id="auto-state">Off</span>
              </div>
            </div>
          </>
        ) : (
          <p class="empty">
            Add your files in <code>public/gallery</code>:
            <br />
            <code>photo-01.jpg</code> + <code>photo-01.txt</code>
          </p>
        )
      }
    </main>

    <script is:inline>
      (() => {
        const root = document.querySelector(".gallery");
        if (!root) return;

        const rawItems = root.dataset.items || "[]";
        const items = JSON.parse(rawItems);
        if (!Array.isArray(items) || !items.length) return;

        const photo = document.getElementById("photo");
        const topDescription = document.getElementById("top-description");
        const topMain = document.getElementById("top-main");
        const topMeta = document.getElementById("top-meta");
        const stageTitle = document.getElementById("stage-title");
        const stageText = document.getElementById("stage-text");
        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const fsBtn = document.getElementById("fs-btn");
        const autoToggle = document.getElementById("auto-toggle");
        const autoState = document.getElementById("auto-state");
        const intro = document.getElementById("intro");
        const startBtn = document.getElementById("start-btn");

        let index = 0;
        let started = false;
        let phaseTimer = null;
        let autoTimer = null;
        let autoEnabled = false;
        let autoToken = 0;
        const DESCRIPTION_PHASE_MS = 5000;
        const PHOTO_TRANSITION_MS = 2500;
        const AUTO_PHOTO_MS = 5000;

        const clearPhaseTimer = () => {
          if (phaseTimer !== null) {
            window.clearTimeout(phaseTimer);
            phaseTimer = null;
          }
        };

        const clearAutoTimer = () => {
          if (autoTimer !== null) {
            window.clearTimeout(autoTimer);
            autoTimer = null;
          }
        };

        const clearAllTimers = () => {
          clearPhaseTimer();
          clearAutoTimer();
        };

        const parseDescription = (description, fallbackTitle) => {
          const lines = description
            .split(/\r?\n/)
            .map((line) => line.trim())
            .filter(Boolean);

          if (!lines.length) {
            return { headline: fallbackTitle, details: [] };
          }

          let headline = lines[0];
          let details = lines.slice(1);

          if (/^description\b/i.test(headline) && details.length) {
            headline = details[0];
            details = details.slice(1);
          }

          let note = "";
          const metaDetails = [];
          for (const detail of details) {
            if (!note && /^notes?\s*:/i.test(detail)) {
              note = detail;
            } else {
              metaDetails.push(detail);
            }
          }

          return {
            headline: headline || fallbackTitle,
            details,
            note,
            metaDetails
          };
        };

        const formatTopMeta = (details) => {
          const separator = "\u00A0\u00A0\u00A0\u2022\u00A0\u00A0\u00A0";
          const compact = details.filter(Boolean).join(separator);
          const maxChars = window.matchMedia("(max-width: 700px)").matches
            ? 190
            : 520;
          return compact.length > maxChars
            ? `${compact.slice(0, maxChars).trimEnd()}...`
            : compact;
        };

        const setTopDescription = (parsedDescription) => {
          if (!topDescription || !topMain || !topMeta) return;
          topMain.textContent = parsedDescription.headline;
          const meta = formatTopMeta([
            ...parsedDescription.metaDetails,
            parsedDescription.note
          ]);
          topMeta.textContent = meta;
          topMeta.style.display = meta ? "" : "none";
        };

        const setDescriptionContent = (parsedDescription) => {
          stageTitle.textContent = parsedDescription.headline;
          stageText.textContent = parsedDescription.details.length
            ? parsedDescription.details.join("\n")
            : "";
        };

        const setPhotoAndTopContent = (item, parsedDescription) => {
          photo.src = item.src;
          photo.alt = parsedDescription.headline || item.title;
          setTopDescription(parsedDescription);
        };

        const setDescriptionPhase = (instant = false) => {
          root.classList.add("auto-description");
          root.classList.remove("desc-on-top");
          if (instant) {
            root.classList.add("instant-hide");
            window.requestAnimationFrame(() => {
              window.requestAnimationFrame(() => {
                root.classList.remove("instant-hide");
              });
            });
          }
        };

        const setPhotoPhase = () => {
          root.classList.remove("auto-description");
          root.classList.add("desc-on-top");
        };

        const syncAutoToggle = () => {
          if (autoToggle) autoToggle.checked = autoEnabled;
          if (autoState) autoState.textContent = autoEnabled ? "On" : "Off";
        };

        const showDescriptionThenPhoto = (item, onPhotoVisible, options = {}) => {
          clearPhaseTimer();
          const parsedDescription = parseDescription(item.description, item.title);
          setDescriptionContent(parsedDescription);
          setDescriptionPhase(Boolean(options.instant));

          phaseTimer = window.setTimeout(() => {
            setPhotoAndTopContent(item, parsedDescription);
            setPhotoPhase();
            if (typeof onPhotoVisible === "function") {
              onPhotoVisible();
            }
          }, DESCRIPTION_PHASE_MS);
        };

        const scheduleAuto = (ms, step, token) => {
          clearAutoTimer();
          autoTimer = window.setTimeout(() => {
            if (!autoEnabled || autoToken !== token) return;
            step();
          }, ms);
        };

        const runAutoCycle = () => {
          if (!started || !autoEnabled) return;
          const token = autoToken;
          const item = items[index];

          showDescriptionThenPhoto(item, () => {
            if (!autoEnabled || autoToken !== token) return;
            scheduleAuto(PHOTO_TRANSITION_MS + AUTO_PHOTO_MS, () => {
              index = (index + 1) % items.length;
              runAutoCycle();
            }, token);
          });
        };

        const stopAuto = (showPhotoPhase = true) => {
          autoEnabled = false;
          autoToken += 1;
          clearAllTimers();
          if (started && showPhotoPhase) setPhotoPhase();
          syncAutoToggle();
        };

        const startAuto = () => {
          if (!started || autoEnabled) return;
          autoEnabled = true;
          autoToken += 1;
          clearAllTimers();
          syncAutoToggle();
          runAutoCycle();
        };

        const renderManual = (nextIndex) => {
          stopAuto(false);
          index = (nextIndex + items.length) % items.length;
          showDescriptionThenPhoto(items[index]);
        };

        const goPrev = () => renderManual(index - 1);
        const goNext = () => renderManual(index + 1);

        const enterFullscreen = async () => {
          if (document.fullscreenElement) return;
          try {
            await document.documentElement.requestFullscreen();
          } catch (_error) {
            // Ignore fullscreen rejection and continue.
          }
        };

        prevBtn?.addEventListener("click", goPrev);
        nextBtn?.addEventListener("click", goNext);
        fsBtn?.addEventListener("click", enterFullscreen);
        autoToggle?.addEventListener("change", () => {
          if (autoToggle.checked) {
            startAuto();
          } else {
            stopAuto();
          }
        });

        const startExhibition = () => {
          if (started) return;
          started = true;
          root.classList.add("started");
          index = 0;
          showDescriptionThenPhoto(items[index], undefined, { instant: true });
          intro?.classList.add("opening");
          window.setTimeout(() => {
            intro?.classList.add("hidden");
          }, 1200);
        };

        startBtn?.addEventListener("click", async () => {
          await enterFullscreen();
          startExhibition();
        });

        document.addEventListener("keydown", (event) => {
          if (!started) {
            if (event.key === "Enter") startBtn?.click();
            return;
          }
          if (event.key === "ArrowRight") goNext();
          if (event.key === "ArrowLeft") goPrev();
          if (event.key === "Backspace") {
            event.preventDefault();
            goPrev();
          }
          if (event.code === "Space") {
            event.preventDefault();
            goNext();
          }
        });

        syncAutoToggle();
      })();
    </script>
  </body>
</html>
